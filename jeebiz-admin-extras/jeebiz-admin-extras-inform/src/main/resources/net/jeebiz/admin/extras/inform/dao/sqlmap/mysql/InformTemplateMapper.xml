<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="net.jeebiz.admin.extras.inform.dao.IInformTemplateDao" >

	<resultMap id="InformTemplateMap" type="InformTemplateModel">
		<!-- 消息通知模板id -->
		<id property="id" column="t_id" />
		<!-- 消息通知模板创建人id -->
		<result property="uid" column="t_uid" />
		<!-- 消息通知模板创建人 -->
		<result property="uname" column="t_uname" />
		<!-- 消息通知模板面向对象 -->
		<result property="target" column="T_TARGET" />
		<!-- 消息通知模板的发送提供者 -->
		<result property="provider" column="T_PROVidER" />
		<!-- 通知信息标题（可能包含变量） -->
		<result property="title" column="T_TITLE" />
		<!-- 通知信息内容（可能包含变量） -->
		<result property="content" column="T_CONTENT" />
		<!-- 消息通知模板对应第三方平台内的模板id -->
		<result property="tid" column="t_tid" />
		<!-- 消息通知模板变量载体,JOSN格式的数据 -->
		<result property="payload" column="T_PAYLOAD" />
		<!-- 消息通知状态：（0:停用、1:启用） -->
		<result property="status" column="t_status" />
		<!-- 消息通知模板已发消息总数 -->
		<result property="total" column="T_TOTAL" />
		<!-- 消息通知模板已发消息未读总数 -->
		<result property="unread" column="T_UNREAD" />
		<!-- 消息通知模板创建时间 -->
		<result property="time24" column="time24"/>
	</resultMap>
	
	<resultMap id="InformTemplateStatsMap" type="net.jeebiz.admin.extras.inform.web.dto.InformTemplateStatsDTO">
		<!-- 消息通知模板的发送提供者 -->
		<result property="provider" column="T_PROVidER" />
		<!-- 消息通知模板已发消息总数 -->
		<result property="total" column="T_TOTAL" />
		<!-- 消息通知模板已发消息未读总数 -->
		<result property="unread" column="T_UNREAD" />
	</resultMap>
	
	<insert id="insert" parameterType="InformTemplateModel" flushCache="true" 
		keyColumn="t_id" keyProperty="id" useGeneratedKeys="true">
		insert into SYS_INFORM_TEMPlatES(t_uid,T_TARGET,T_PROVidER,T_TITLE,T_CONTENT,t_tid,T_PAYLOAD,t_status)
		values(#{uid},#{target},#{provider},#{title},#{content,jdbcType=VARCHAR},#{tid,jdbcType=VARCHAR},#{payload,jdbcType=VARCHAR},'0')
	</insert>
	
	<delete id="delete" parameterType="java.lang.String">
		DELETE FROM SYS_INFORM_TEMPlatES WHERE t_id = #{id}
	</delete>

	<delete id="batchDelete" flushCache="true">
		DELETE FROM SYS_INFORM_TEMPlatES WHERE t_id IN
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">  
           #{item} 
        </foreach>
	</delete>

	<update id="setStatus" parameterType="java.lang.String" flushCache="true">
		UPDATE SYS_INFORM_TEMPlatES t
		   SET t.t_status = #{status}
		 WHERE t.t_id = #{id}
	</update>
	
	<update id="update" parameterType="InformTemplateModel">
		UPDATE SYS_INFORM_TEMPlatES t
		   SET t.T_TARGET = #{target},
		   	   t.T_PROVidER = #{provider},
		   	   t.T_TITLE = #{title},
		   	   t.T_CONTENT = #{content,jdbcType=VARCHAR},
		   	   t.t_tid = #{tid,jdbcType=VARCHAR},
		   	   t.T_PAYLOAD = #{payload,jdbcType=VARCHAR}
		 WHERE t.t_id = #{id}
	</update>
	
	<select id="getCount" resultType="int" parameterType="InformTemplateModel" useCache="false">
		SELECT count(t.t_id)
		  FROM SYS_INFORM_TEMPlatES t
		 WHERE t.T_TITLE = #{title}
		   AND t.t_uid = #{uid}
	</select>
	
	<select id="getPagedList" resultMap="InformTemplateMap" >
		SELECT t.t_id,
			   t.t_uid,
			   (SELECT IFNULL(x.u_alias,x.u_username) FROM sys_authz_user_list x WHERE x.u_id = t.t_uid) as t_uname,
			   t.T_TARGET,
			   t.T_PROVidER,
			   t.T_TITLE,
			   t.T_CONTENT,
			   t.t_tid,
			   t.T_PAYLOAD,
			   t.t_status
			   IFNULL(( SELECT COUNT( x.r_id ) FROM SYS_INFORM_RECORDS x WHERE x.R_Tid = t.t_id ),0) AS T_TOTAL,
			   IFNULL(( SELECT count( x.r_id ) FROM SYS_INFORM_RECORDS x WHERE x.R_Tid = t.t_id AND t.r_status = 0 ),0) AS T_UNREAD,
			   t.time24
		  FROM SYS_INFORM_TEMPlatES t
	   	<where>
			<if test="model.uid != null and model.uid != '' ">
				AND t.t_uid = #{model.uid}
			</if>
			<if test="model.provider != null and model.provider != '' ">
				AND t.T_PROVidER = #{model.provider}
			</if>
			<if test="model.target != null and model.target != '' ">
				AND t.T_TARGET = #{model.target}
			</if>
			<if test="model.status != null and model.status != '' ">
				AND t.t_status = #{model.status}
			</if>
			<if test="model.keywords != null and model.keywords != '' ">
				AND t.T_TITLE like CONCAT('%',#{model.keywords},'%')
			</if>
		</where>
	</select>
	
	<select id="getModel" resultMap="InformTemplateMap" parameterType="String" >
		SELECT t.t_id,
			   t.t_uid,
			   (SELECT IFNULL(x.u_alias,x.u_username) FROM sys_authz_user_list x WHERE x.u_id = t.t_uid) as t_uname,
			   t.T_TARGET,
			   t.T_PROVidER,
			   t.T_TITLE,
			   t.T_CONTENT,
			   t.t_tid,
			   t.T_PAYLOAD,
			   t.t_status
			   IFNULL(( SELECT COUNT( x.r_id ) FROM SYS_INFORM_RECORDS x WHERE x.R_Tid = t.t_id ),0) AS T_TOTAL,
			   IFNULL(( SELECT count( x.r_id ) FROM SYS_INFORM_RECORDS x WHERE x.R_Tid = t.t_id AND t.r_status = 0 ),0) AS T_UNREAD,
			   t.time24
		  FROM SYS_INFORM_TEMPlatES t
	   WHERE t.t_id = #{id}
	</select>
	
	<select id="getStats" resultMap="InformTemplateStatsMap">
		SELECT t.T_PROVidER,
			   IFNULL(( SELECT COUNT( x.r_id ) FROM SYS_INFORM_RECORDS x WHERE x.R_Tid = t.t_id ),0) AS T_TOTAL,
			   IFNULL(( SELECT count( x.r_id ) FROM SYS_INFORM_RECORDS x WHERE x.R_Tid = t.t_id AND t.r_status = 0 ),0) AS T_UNREAD
		FROM SYS_INFORM_TEMPlatES t, SYS_INFORM_TARGETS t2
	   WHERE t.t_id = t2.t_id
	   GROUP BY t.T_PROVidER
	</select>
	
</mapper>
