<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="net.jeebiz.admin.extras.inform.dao.IInformTemplateDao" >

	<resultMap id="InformTemplateMap" type="InformTemplateModel">
		<!-- 消息通知模板ID -->
		<id property="id" column="T_ID" />
		<!-- 消息通知模板创建人ID -->
		<result property="uid" column="T_UID" />
		<!-- 消息通知模板创建人 -->
		<result property="uname" column="T_UNAME" />
		<!-- 消息通知模板面向对象 -->
		<result property="target" column="T_TARGET" />
		<!-- 消息通知模板的发送提供者 -->
		<result property="provider" column="T_PROVIDER" />
		<!-- 通知信息标题（可能包含变量） -->
		<result property="title" column="T_TITLE" />
		<!-- 通知信息内容（可能包含变量） -->
		<result property="content" column="T_CONTENT" />
		<!-- 消息通知模板对应第三方平台内的模板ID -->
		<result property="tid" column="T_TID" />
		<!-- 消息通知模板变量载体,JOSN格式的数据 -->
		<result property="payload" column="T_PAYLOAD" />
		<!-- 消息通知状态：（0:停用、1:启用） -->
		<result property="status" column="T_STATUS" />
		<!-- 消息通知模板已发消息总数 -->
		<result property="total" column="T_TOTAL" />
		<!-- 消息通知模板已发消息未读总数 -->
		<result property="unread" column="T_UNREAD" />
		<!-- 消息通知模板创建时间 -->
		<result property="time24" column="TIME24"/>
	</resultMap>
	
	<resultMap id="InformTemplateStatsMap" type="net.jeebiz.admin.extras.inform.web.vo.InformTemplateStatsVo">
		<!-- 消息通知模板的发送提供者 -->
		<result property="provider" column="T_PROVIDER" />
		<!-- 消息通知模板已发消息总数 -->
		<result property="total" column="T_TOTAL" />
		<!-- 消息通知模板已发消息未读总数 -->
		<result property="unread" column="T_UNREAD" />
	</resultMap>
	
	<insert id="insert" parameterType="InformTemplateModel" flushCache="true" >
		<selectKey keyProperty="id" order="BEFORE" resultType="String">  
	        SELECT sys_guid() FROM dual
	    </selectKey>
		insert into SYS_INFORM_TEMPLATES(T_ID,T_UID,T_TARGET,T_PROVIDER,T_TITLE,T_CONTENT,T_TID,T_PAYLOAD,T_STATUS)
		values(#{id},#{uid},#{target},#{provider},#{title},#{content,jdbcType=VARCHAR},#{tid,jdbcType=VARCHAR},#{payload,jdbcType=VARCHAR},'0')
	</insert>
	
	<delete id="delete" parameterType="java.lang.String">
		DELETE FROM SYS_INFORM_TEMPLATES WHERE T_ID = #{id}
	</delete>

	<delete id="batchDelete" flushCache="true">
		DELETE FROM SYS_INFORM_TEMPLATES WHERE T_ID IN 
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">  
           #{item} 
        </foreach>
	</delete>

	<update id="setStatus" parameterType="java.lang.String" flushCache="true">
		UPDATE SYS_INFORM_TEMPLATES t 
		   SET t.T_STATUS = #{status}
		 WHERE t.T_ID = #{id}
	</update>
	
	<update id="update" parameterType="InformTemplateModel">
		UPDATE SYS_INFORM_TEMPLATES t 
		   SET t.T_TARGET = #{target},
		   	   t.T_PROVIDER = #{provider},
		   	   t.T_TITLE = #{title},
		   	   t.T_CONTENT = #{content,jdbcType=VARCHAR},
		   	   t.T_TID = #{tid,jdbcType=VARCHAR},
		   	   t.T_PAYLOAD = #{payload,jdbcType=VARCHAR}
		 WHERE t.T_ID = #{id}
	</update>
	
	<select id="getCount" resultType="int" parameterType="InformTemplateModel" useCache="false">
		SELECT count(t.T_ID) 
		  FROM SYS_INFORM_TEMPLATES t 
		 WHERE t.T_TITLE = #{title}
		   AND t.T_UID = #{uid}
	</select>
	
	<select id="getPagedList" resultMap="InformTemplateMap" >
		SELECT t.T_ID,
			   t.T_UID,
			   (SELECT IFNULL(x.U_ALIAS,x.U_USERNAME) FROM SYS_AUTHZ_USER_LIST x WHERE x.U_ID = t.T_UID) as T_UNAME, 
			   t.T_TARGET,
			   t.T_PROVIDER,
			   t.T_TITLE,
			   t.T_CONTENT,
			   t.T_TID,
			   t.T_PAYLOAD,
			   t.T_STATUS
			   IFNULL(( SELECT COUNT( x.R_ID ) FROM SYS_INFORM_RECORDS x WHERE x.R_TID = t.T_ID ),0) AS T_TOTAL, 
			   IFNULL(( SELECT count( x.R_ID ) FROM SYS_INFORM_RECORDS x WHERE x.R_TID = t.T_ID AND t.R_STATUS = 0 ),0) AS T_UNREAD,
			   t.TIME24
		  FROM SYS_INFORM_TEMPLATES t
	   	<where>
			<if test="model.uid != null and model.uid != '' ">
				AND t.T_UID = #{model.uid}
			</if>
			<if test="model.provider != null and model.provider != '' ">
				AND t.T_PROVIDER = #{model.provider}
			</if>
			<if test="model.target != null and model.target != '' ">
				AND t.T_TARGET = #{model.target}
			</if>
			<if test="model.status != null and model.status != '' ">
				AND t.T_STATUS = #{model.status}
			</if>
			<if test="model.keywords != null and model.keywords != '' ">
				AND t.T_TITLE like '%'|| #{model.keywords} ||'%'
			</if>
		</where>
	</select>
	
	<select id="getModel" resultMap="InformTemplateMap" parameterType="String" >
		SELECT t.T_ID,
			   t.T_UID,
			   (SELECT IFNULL(x.U_ALIAS,x.U_USERNAME) FROM SYS_AUTHZ_USER_LIST x WHERE x.U_ID = t.T_UID) as T_UNAME, 
			   t.T_TARGET,
			   t.T_PROVIDER,
			   t.T_TITLE,
			   t.T_CONTENT,
			   t.T_TID,
			   t.T_PAYLOAD,
			   t.T_STATUS
			   IFNULL(( SELECT COUNT( x.R_ID ) FROM SYS_INFORM_RECORDS x WHERE x.R_TID = t.T_ID ),0) AS T_TOTAL, 
			   IFNULL(( SELECT count( x.R_ID ) FROM SYS_INFORM_RECORDS x WHERE x.R_TID = t.T_ID AND t.R_STATUS = 0 ),0) AS T_UNREAD,
			   t.TIME24
		  FROM SYS_INFORM_TEMPLATES t
	   WHERE t.T_ID = #{id}
	</select>
	
	<select id="getStats" resultMap="InformTemplateStatsMap">
		SELECT t.T_PROVIDER,
			   IFNULL(( SELECT COUNT( x.R_ID ) FROM SYS_INFORM_RECORDS x WHERE x.R_TID = t.T_ID ),0) AS T_TOTAL,
			   IFNULL(( SELECT count( x.R_ID ) FROM SYS_INFORM_RECORDS x WHERE x.R_TID = t.T_ID AND t.R_STATUS = 0 ),0) AS T_UNREAD
		FROM SYS_INFORM_TEMPLATES t, SYS_INFORM_TARGETS t2
	   WHERE t.T_ID = t2.T_ID
	   GROUP BY t.T_PROVIDER
	</select>
	
</mapper>