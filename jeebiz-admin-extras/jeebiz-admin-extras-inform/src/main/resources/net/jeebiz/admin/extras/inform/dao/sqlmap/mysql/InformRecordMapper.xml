<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="net.jeebiz.admin.extras.inform.dao.IInformRecordDao" >

	<resultMap id="InformRecordMap" type="InformRecordModel">
		<!-- 消息通知记录ID -->
		<id property="id" column="R_ID" />
		<!-- 消息通知发送人ID -->
		<result property="uid" column="R_UID" />
		<!-- 消息通知发送人 -->
		<result property="uname" column="R_UNAME" />
		<!-- 消息通知的发送提供者 -->
		<result property="provider" column="R_PROVIDER" />
		<!-- 消息通知标签（自定义的通知标签，用于判断逻辑，如：1：信息通知、2：发起审批、3：审批通过、4：审批拒绝） -->
		<result property="tag" column="R_TAG" />
		<!-- 消息通知接收人ID -->
		<result property="toUid" column="R_TO" />
		<!-- 消息通知接收人 -->
		<result property="toUname" column="R_TO_UNAME" />
		<!-- 消息通知标题（变量处理后的标题） -->
		<result property="title" column="R_TITLE" />
		<!-- 消息通知内容（变量处理后的内容） -->
		<result property="content" column="R_CONTENT" />
		<!-- 消息通知模板ID（系统内信息模板、微信订阅消息等模板ID） -->
		<result property="tid" column="R_TID" />
		<!-- 通知信息关联数据载体,JOSN格式的数据 -->
		<result property="payload" column="R_PAYLOAD" />
		<!-- 消息通知阅读状态：（0:未阅读、1:已阅读） -->
		<result property="status" column="R_STATUS" />
		<!-- 消息通知创建时间 -->
		<result property="time24" column="TIME24"/>
	</resultMap>
	
	<resultMap id="InformRecordStatsMap" type="net.jeebiz.admin.extras.inform.web.dto.InformRecordStatsDTO">
		<!-- 消息通知的发送提供者 -->
		<result property="provider" column="R_PROVIDER" />
		<!-- 该类型通知总数 -->
		<result property="total" column="R_TOTAL" />
		<!-- 该类型未读通知总数 -->
		<result property="unread" column="R_UNREAD" />
	</resultMap>
	
	<insert id="insert" parameterType="InformRecordModel">
		insert into SYS_INFORM_RECORDS(R_UID,R_PROVIDER,R_TAG,R_TO,R_TITLE,R_CONTENT,R_TID,R_PAYLOAD,R_STATUS)
		values(#{uid},#{provider},#{tag,jdbcType=VARCHAR},#{toUid},#{title},#{content,jdbcType=VARCHAR},#{tid,jdbcType=VARCHAR},#{payload,jdbcType=VARCHAR},0)
	</insert>
	
	<delete id="deleteByTid">
		delete from SYS_INFORM_RECORDS where R_TID = #{tid}
	</delete>
	
	<delete id="deleteByUid">
		delete from SYS_INFORM_RECORDS where R_TO = #{toUid}
		<if test="ids != null">
		<foreach collection="ids" item="id" open=" AND (" separator=" OR " close=")" >
			R_ID = #{id}
		</foreach>
		</if>
	</delete>
	
	<update id="update" parameterType="InformRecordModel">
		UPDATE SYS_INFORM_RECORDS t 
		   SET t.R_STATUS = #{status}
		 WHERE t.R_TO = #{toUid}
		 <if test="ids != null">
			 <foreach collection="ids" item="item" open=" AND (" separator=" OR " close=")" >
				t.R_ID = #{item}
			 </foreach>
		 </if>
	</update>
	
	<select id="getCount" resultType="Integer" parameterType="InformRecordModel">
		SELECT IFNULL(COUNT(t.R_ID), 0) COUNT 
		FROM SYS_INFORM_RECORDS t
		WHERE t.R_TO = #{toUid}
		  AND t.R_STATUS = 0
	</select>
	
	<select id="getPagedList" resultMap="InformRecordMap" >
		SELECT t.R_ID,
			   t.R_UID,
			   (SELECT IFNULL(x.U_ALIAS,x.U_USERNAME) FROM SYS_AUTHZ_USER_LIST x WHERE x.U_ID = t.R_UID) as R_UNAME, 
		   	   t.R_PROVIDER,
		   	   t.R_TAG,
			   t.R_TITLE,
			   t.R_CONTENT,
			   t.R_TID,
			   t.R_TO,
			   (SELECT IFNULL(x.U_ALIAS,x.U_USERNAME) FROM SYS_AUTHZ_USER_LIST x WHERE x.U_ID = t.R_TO) as R_TO_UNAME,
			   t.R_PAYLOAD,
			   t.R_STATUS,
			   t.TIME24
		  FROM SYS_INFORM_RECORDS t
	   <where>
		   <if test="model.toUid != null and model.toUid != '' ">
				AND t.R_TO = #{model.toUid}
			</if>
			<if test="model.provider != null and model.provider != '' ">
				AND t.T_PROVIDER = #{model.provider}
			</if>
			<if test="model.status != null and model.status != '' ">
				AND t.R_STATUS = #{model.status}
			</if>
			<if test="model.keywords != null and model.keywords != '' ">
				AND t.R_TITLE like CONCAT('%',#{model.keywords},'%')
			</if>
	   </where>
		ORDER BY t.TIME24 DESC
	</select>
	
	<select id="getModel" resultMap="InformRecordMap" parameterType="String" >
		SELECT t.R_ID,
			   t.R_UID,
			   (SELECT IFNULL(x.U_ALIAS,x.U_USERNAME) FROM SYS_AUTHZ_USER_LIST x WHERE x.U_ID = t.R_UID) as R_UNAME, 
		   	   t.R_PROVIDER,
		   	   t.R_TAG,
			   t.R_TITLE,
			   t.R_CONTENT,
			   t.R_TID,
			   t.R_TO,
			   (SELECT IFNULL(x.U_ALIAS,x.U_USERNAME) FROM SYS_AUTHZ_USER_LIST x WHERE x.U_ID = t.R_TO) as R_TO_UNAME,
			   t.R_PAYLOAD,
			   t.R_STATUS,
			   t.TIME24
		  FROM SYS_INFORM_RECORDS t
	     WHERE t.R_ID = #{id}
	</select>
	
	<select id="getStats" resultMap="InformRecordStatsMap">
		SELECT t.R_PROVIDER,
			   COUNT( t.R_ID ) as R_TOTAL,
		   	   SUM( CASE WHEN t.R_STATUS = '0' THEN 1 ELSE 0 END ) as R_UNREAD
		FROM SYS_INFORM_RECORDS t
	   WHERE t.R_TO = #{toUid}
	   GROUP BY t.R_PROVIDER
	</select>
	
</mapper>